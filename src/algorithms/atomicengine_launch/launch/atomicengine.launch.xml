<?xml version="1.0"?>
<launch>
  <arg name="use_sim_time" default="true" />
  <arg name="lidar_frame" default="velodyne_top" />
  <arg name="lidar_topic" default="/sensing/lidar/concatenated/pointcloud" />
  <arg name="output_path" default="/home/map4/atomicengine_output" />
  <arg name="detection_model" default="apollo" /> <!-- "apollo"か"centerpoint". モデルファイルは"atomicengine_data"にあります。-->
  <arg name="twist_topic" default="/localization/pose_twist_fusion_filter/twist_with_covariance"/>

  <set_parameter name="use_sim_time" value="$(var use_sim_time)" />

  <!-- Apollo Detection Model -->
  <group if="$(eval &quot;'$(var detection_model)' == 'apollo'&quot;)">
    <include file="$(find-pkg-share map4_lidar_apollo_instance_segmentation)/launch/lidar_apollo_instance_segmentation.launch.xml">
      <arg name="input/pointcloud" value="$(var lidar_topic)" />
      <arg name="output/objects" value="/clusters" />
      <arg name="target_frame" value="base_link" />
      <arg name="z_offset" value="-2.0" />
      <arg name="x_offset" value="0.0" />
    </include>

    <node pkg="map4_shape_estimation" exec="shape_estimation_node" name="shape_estimation_node" output="screen">
      <remap from="input" to="/clusters"/>
      <remap from="objects" to="/objects_with_feature"/>
      <param from="$(find-pkg-share map4_shape_estimation)/config/shape_estimation.param.yaml"/>
    </node>

    <node pkg="autoware_detected_object_feature_remover" exec="detected_object_feature_remover_node" name="detected_object_feature_remover_node" output="screen">
      <remap from="~/input" to="/objects_with_feature"/>
      <remap from="~/output" to="/detected_objects"/>
    </node>
  </group>

  <!-- Centerpoint Detection Model -->
  <group if="$(eval &quot;'$(var detection_model)' == 'centerpoint'&quot;)">
    <include file="$(find-pkg-share map4_lidar_centerpoint)/launch/lidar_centerpoint.launch.xml">
      <arg name="input/pointcloud" value="$(var lidar_topic)" />
      <arg name="output/objects" value="/detected_objects" />
    </include>
  </group>

  <!-- Tracking -->
  <arg name="tracker_setting_path" default="$(find-pkg-share map4_multi_object_tracker)/config/multi_object_tracker_node.param.yaml"/>
  <arg name="data_association_matrix_path" default="$(find-pkg-share map4_multi_object_tracker)/config/data_association_matrix.param.yaml"/>
  <arg name="input_channels_path" default="$(find-pkg-share map4_multi_object_tracker)/config/input_channels.param.yaml"/>

  <node pkg="map4_multi_object_tracker" exec="multi_object_tracker_node" name="multi_object_tracker_node" output="screen">
    <param name="selected_input_channels" value="['detected_objects']"/>
    <remap from="output" to="/tracked_objects"/>
    <param from="$(var tracker_setting_path)"/>
    <param from="$(var data_association_matrix_path)"/>
    <param from="$(var input_channels_path)"/>
  </node>

  <node pkg="objects_to_csv" exec="tracked_objects_to_csv" output="screen">
    <param name="input_topic" value="/tracked_objects"/>
    <param name="twist_topic" value="$(var twist_topic)"/>
    <param name="csv_directory_path" value="$(var output_path)"/>
    <param name="lidar_frame" value="$(var lidar_frame)"/>
  </node>

</launch>
